<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点歌队列</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<body>
    <div class="fixed top-4 left-4 z-50">
        <a href="/" class="bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 flex items-center justify-center w-12 h-12">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
            </svg>
        </a>
    </div>
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-6">点歌队列</h1>
        <div id="queue-list" class="grid grid-cols-3 gap-4">
            {% for song in queue %}
            <div class="bg-white rounded-lg shadow-md p-4 flex" data-song-index="{{ loop.index0 }}">
                <img src="/cover/{{ song.id }}.png" alt="{{ song.name }}" class="w-24 h-24 object-cover rounded-md mr-4">
                <div class="flex-grow">
                    <h2 class="text-xl font-semibold break-words">{{ loop.index0 + 1 }}. {{ song.name }}</h2>
                    <p class="text-gray-600">曲{{ song.artist | default('未知') }}</p>
                    <p class="text-gray-600">{% if song.type == 'SD' %}标准谱{% elif song.type == 'DX' %}DX谱{% endif %}</p>
                    <div class="flex mt-2">
                        {% if song.ds %}
                            {% for difficulty in song.ds %}
                                {% set bgColor = '' %}
                                {% if song.ds|length == 1 %}
                                    {% set bgColor = 'bg-pink-500' %}
                                {% elif song.ds|length == 2 %}
                                    {% set bgColor = 'bg-pink-500' %}
                                {% else %}
                                    {% if loop.index0 == 0 %}
                                        {% set bgColor = 'bg-green-500' %}
                                    {% elif loop.index0 == 1 %}
                                        {% set bgColor = 'bg-yellow-500' %}
                                    {% elif loop.index0 == 2 %}
                                        {% set bgColor = 'bg-red-500' %}
                                    {% elif loop.index0 == 3 %}
                                        {% set bgColor = 'bg-purple-500' %}
                                    {% elif loop.index0 == 4 %}
                                        {% set bgColor = 'bg-purple-200 text-gray-800' %}
                                    {% else %}
                                        {% set bgColor = 'bg-gray-300' %}
                                    {% endif %}
                                {% endif %}
                                <span class="{{ bgColor }} text-white text-xs font-bold px-2 py-1 rounded-full mr-1">{{ difficulty }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-col justify-between ml-4">
                    <button class="bg-gray-400 text-white px-2 py-1 rounded-md hover:bg-gray-500 mb-2 move-up-btn">上移</button>
                    <button class="bg-gray-400 text-white px-2 py-1 rounded-md hover:bg-gray-500 mb-2 move-down-btn">下移</button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 delete-btn">删除</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.move-up-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.closest('[data-song-index]').dataset.songIndex);
                    moveSong(index, 'up');
                });
            });

            document.querySelectorAll('.move-down-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.closest('[data-song-index]').dataset.songIndex);
                    moveSong(index, 'down');
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const button = this;
                    if (button.dataset.confirm === 'true') {
                        const index = parseInt(button.closest('[data-song-index]').dataset.songIndex);
                        deleteSong(index);
                    } else {
                        button.textContent = '确认删除';
                        button.dataset.confirm = 'true';
                        setTimeout(() => {
                            button.textContent = '删除';
                            button.dataset.confirm = 'false';
                        }, 3000); // Reset after 3 seconds
                    }
                });
            });

            function moveSong(index, direction) {
                fetch('/move_queue_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ index: index, direction: direction }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to reflect changes
                    } else {
                        alert(data.message);
                    }
                });
            }

            function deleteSong(index) {
                fetch('/remove_from_queue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ index: index }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to reflect changes
                    } else {
                        alert(data.message);
                    }
                });
            }

            function fetchQueueAndRender() {
                fetch('/get_queue')
                    .then(response => response.json())
                    .then(queue => {
                        const queueList = document.getElementById('queue-list');
                        queueList.innerHTML = ''; // Clear current list
                        queue.forEach((song, index) => {
                            const songCard = `
                                <div class="bg-white rounded-lg shadow-md p-4 flex" data-song-index="${index}">
                                    <img src="/cover/${song.id}.png" alt="${song.name}" class="w-24 h-24 object-cover rounded-md mr-4">
                                    <div class="flex-grow">
                                    <h2 class="text-xl font-semibold break-words">${index + 1}. ${song.name}</h2>
                                        <p class="text-gray-600">${song.artist || '未知曲师'}</p>
                                        <p class="text-gray-600">${song.type === 'SD' ? '标准谱' : song.type === 'DX' ? 'DX谱' : ''}</p>
                                        <div class="flex mt-2">
                                            ${(song.ds || []).map((difficulty, difficultyIndex) => {
                                                let bgColor = '';
                                                if (song.ds && song.ds.length === 1) {
                                                    bgColor = 'bg-pink-450';
                                                } else if (song.ds && song.ds.length === 2) {
                                                    bgColor = 'bg-pink-450';
                                                } else {
                                                    switch(difficultyIndex) {
                                                        case 0: bgColor = 'bg-green-500'; break;
                                                        case 1: bgColor = 'bg-yellow-500'; break;
                                                        case 2: bgColor = 'bg-red-500'; break;
                                                        case 3: bgColor = 'bg-purple-500'; break;
                                                        case 4: bgColor = 'bg-purple-100 text-gray-800'; break;
                                                        default: bgColor = 'bg-gray-300';
                                                    }
                                                }
                                                return `<span class="${bgColor} text-white text-xs font-bold px-2 py-1 rounded-full mr-1">${difficulty}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="flex flex-col justify-between ml-4">
                                        <button class="bg-gray-400 text-white px-2 py-1 rounded-md hover:bg-gray-500 mb-2 move-up-btn">上移</button>
                                        <button class="bg-gray-400 text-white px-2 py-1 rounded-md hover:bg-gray-500 mb-2 move-down-btn">下移</button>
                                        <button class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 delete-btn">删除</button>
                                    </div>
                                </div>
                            `;
                            queueList.innerHTML += songCard;
                        });
                        // Re-attach event listeners after re-rendering
                        attachEventListeners();
                    });
            }

            function attachEventListeners() {
                document.querySelectorAll('.move-up-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.closest('[data-song-index]').dataset.songIndex);
                        moveSong(index, 'up');
                    });
                });

                document.querySelectorAll('.move-down-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.closest('[data-song-index]').dataset.songIndex);
                        moveSong(index, 'down');
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const button = this;
                        if (button.dataset.confirm === 'true') {
                            const index = parseInt(button.closest('[data-song-index]').dataset.songIndex);
                            deleteSong(index);
                        } else {
                            button.textContent = '确认删除';
                            button.dataset.confirm = 'true';
                            setTimeout(() => {
                                button.textContent = '删除';
                                button.dataset.confirm = 'false';
                            }, 3000); // Reset after 3 seconds
                        }
                    });
                });
            }

            fetchQueueAndRender(); // Initial load
            setInterval(fetchQueueAndRender, 5000); // Refresh every 5 seconds
        });
    </script>
</body>
</html>